{% extends "base.html" %}
{% block title %}Configure Pipeline Run{% endblock %}

{% block content %}

<h2>Configure Pipeline Run</h2>

<p>
  Review the selected documents, choose a preset, or fine-tune advanced options
  before executing the dataset generation pipeline.
</p>

<form method="post" action="{{ url_for('pipeline.execute_pipeline') }}" class="form-card">

  <!-- ===================== -->
  <!-- SELECTED DOCUMENTS -->
  <!-- ===================== -->
  <fieldset class="form-section">
    <legend>Selected Documents</legend>

    <ul class="document-list">
      {% for doc in documents %}
        <li>
          <strong>{{ doc.title }}</strong>
          <div class="muted">
            {{ doc.domain.code }} /
            {{ doc.audience.code }} /
            {{ doc.criticality.code }}
          </div>
        </li>

        <!-- ✅ MUST BE INSIDE FORM -->
        <input type="hidden" name="document_ids" value="{{ doc.id }}">
      {% endfor %}
    </ul>
  </fieldset>

  <!-- ===================== -->
  <!-- PIPELINE PRESETS -->
  <!-- ===================== -->
  <fieldset class="form-section">
    <legend>Pipeline Preset</legend>

    {% for key, preset in presets.items() %}
      <div class="form-row">
        <label class="radio-label">
          <input
            type="radio"
            name="preset"
            value="{{ key }}"
            {% if loop.first %}checked{% endif %}
          >
          <strong>{{ preset.label }}</strong>
        </label>
        <div class="help-text">
          {{ preset.description }}
        </div>
      </div>
    {% endfor %}
  </fieldset>

  <!-- ===================== -->
  <!-- ANSWER MODEL -->
  <!-- ===================== -->
  <fieldset class="form-section">
    <legend>Answer Model</legend>

    <p class="help-text">
      Select the model used to generate answers.
      <strong>Mistral is recommended</strong>.
    </p>

    <div class="form-row">
      <label for="models">
        Answer Model
      </label>

      <select name="models" id="models" required>
        {% for model in answer_models %}
          <option
            value="{{ model.name }}"
            {% if "mistral" in model.name|lower %}selected{% endif %}
          >
            {{ model.name }}
            {% if model.model_type %}({{ model.model_type }}){% endif %}
          </option>
        {% endfor %}
      </select>

      <div class="help-text">
        Only enabled models from the database are shown.
      </div>
    </div>
  </fieldset>



  <!-- ===================== -->
  <!-- ADVANCED SETTINGS -->
  <!-- ===================== -->
  <fieldset class="form-section">
    <legend>Advanced Settings</legend>

    <div class="form-row">
      <label>Max Chunks</label>
      <input type="number" name="max_chunks" placeholder="All">
      <div class="help-text">Blank = process all chunks</div>
    </div>

    <div class="form-row">
      <label>Minimum Context Length</label>
      <input type="number" name="min_context_len" value="40">
    </div>

    <div class="form-row">
      <label>Questions per Chunk</label>
      <input type="number" name="num_questions" value="3">
    </div>

    <div class="form-row">
      <label>Max Question Retries</label>
      <input type="number" name="max_q_retries" value="3">
    </div>

    <div class="form-row">
      <label>Similarity Threshold</label>
      <input type="number" step="0.05" name="similarity_threshold" value="0.7">
    </div>

    <div class="form-row checkbox-row">
      <label>
        <input type="checkbox" name="embed">
        Store embeddings
      </label>
    </div>

    <div class="form-row checkbox-row">
      <label>
        <input type="checkbox" name="test_mode">
        Test mode (single chunk / single question)
      </label>
    </div>
  </fieldset>

  <!-- ===================== -->
  <!-- ACTIONS -->
  <!-- ===================== -->
  <div class="form-actions">
    <button type="submit" class="primary">
      Run Dataset Pipeline
    </button>

    <a href="{{ url_for('pipeline.select_documents') }}" class="secondary">
      ← Back to Document Selection
    </a>
  </div>

</form>

<p class="muted" style="margin-top:16px;">
  Pipeline progress will be printed to the terminal.
</p>

{% endblock %}
